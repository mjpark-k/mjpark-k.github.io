# ë‹¤ì–‘í•œ ì¿¼ë¦¬ ì‚¬ìš©í•˜ê¸° (React Query)

## âœ” Dependant Queryë€?

ë§Œì•½ ì–´ë–¤ ë‘ ì¿¼ë¦¬ê°€ ì˜ì¡´ê´€ê³„ê°€ ìˆì–´ ì–´ë–¤ íŠ¹ì • ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ì´ ë˜ì–´ì•¼ í•˜ëŠ” ê²½ìš°ì—ëŠ” ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œìš”? ì˜ˆë¥¼ ë“¤ì–´ì„œ ë‹¤ìŒê³¼ ê°™ì´ ë‘ ê°œì˜ ì¿¼ë¦¬ê°€ ìˆë‹¤ê³  í•´ë´…ì‹œë‹¤. ì²« ë²ˆì§¸ ì¿¼ë¦¬ëŠ” ìœ ì €ì˜ ì •ë³´ë¥¼ ë°›ì•„ ì˜¤ê³ , ë‘ë²ˆì§¸ ì¿¼ë¦¬ëŠ” ë°›ì•„ì˜¨ ìœ ì €ì˜ ì •ë³´ì—ì„œ ì•„ì´ë””ë¥¼ ì´ìš©í•´ í•´ë‹¹ ìœ ì €ì˜ í”„ë¡œì íŠ¸ë¥¼ ë°›ì•„ ì˜¤ê²Œ ë©ë‹ˆë‹¤.

```js
const { data: user } = useQuery({
  queryKey: ["user", email],
  queryFn: getUserByEmail,
});

const userId = user?.id;

const { data: projects } = useQuery({
  queryKey: ["projects", userId],
  queryFn: getProjectsByUser,
});
```

ì´ëŸ° ìƒí™©ì—ì„œ ìš°ë¦¬ëŠ” `useQuery()`ì˜ `enabled` ì˜µì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `enabled` ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´ `enabled` ê°’ì´ trueê°€ ë˜ì–´ì•¼ë§Œ í•´ë‹¹ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ëŠ”ë°ìš”. ì´ë ‡ê²Œ ì–´ë–¤ íŠ¹ì • ê°’ì´ë‚˜ ì¡°ê±´ì´ ì¶©ì¡±ëœ ì´í›„ì— ì‹¤í–‰ë˜ëŠ” ì¿¼ë¦¬ë¥¼ Dependant Queryë¼ê³  í•©ë‹ˆë‹¤.

ë§Œì•½ ì–´ë–¤ ì¿¼ë¦¬ê°€ `userId` ê°’ì´ ìˆì„ ë•Œë§Œ ì‹¤í–‰í•˜ë„ë¡ í•˜ê³  ì‹¶ìœ¼ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •í•´ ì£¼ë©´ ë©ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ `userId`ê°€ ìˆëŠ” ê²½ìš° `true`, ì—†ëŠ” ê²½ìš° `false`ë¡œ ì˜µì…˜ê°’ì´ ì„¤ì •ë  ê±°ì—ìš”.

```js
const { data: user } = useQuery({
  queryKey: ["user", email],
  queryFn: getUserByEmail,
});

const userId = user?.id;

const { data: projects } = useQuery({
  queryKey: ["projects", userId],
  queryFn: getProjectsByUser,
  enabled: !!userId,
});
```

ìœ„ ìƒí™©ì—ì„œëŠ” ë‘ ê°œì˜ ì¿¼ë¦¬ë¥¼ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•˜ë ¤ê³  `enabled` ì˜µì…˜ì„ ì‚¬ìš©í–ˆì§€ë§Œ, `enabled` ì˜µì…˜ê°’ìœ¼ë¡œ ê¼­ ì•ì„  ì¿¼ë¦¬ì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ê°€ ë“¤ì–´ê°€ì•¼ë§Œ í•˜ëŠ” ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤. ì‚¬ì‹¤ ìœ„ì˜ ê²½ìš°ì—ë„ ë°±ì—”ë“œ API ì„¤ê³„ì— ë”°ë¼ì„œ ë‘ ë²ˆì˜ ì¿¼ë¦¬ê°€ ì•„ë‹ˆë¼ í•œ ë²ˆì˜ ì¿¼ë¦¬ë¡œ ëë‚¼ ìˆ˜ë„ ìˆëŠ”ë°ìš”. ì˜ˆë¥¼ ë“¤ì–´ `getProjectsByUserEmail()` ì´ë¼ëŠ” í•¨ìˆ˜ë¥¼ í†µí•´ ìœ ì €ì˜ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ë°±ì—”ë“œë¡œ ì „ë‹¬í•˜ê³ , ê·¸ì— ë§ëŠ” ìœ ì €ì˜ í”„ë¡œì íŠ¸ë¥¼ ë°›ì„ ìˆ˜ ìˆëŠ” APIê°€ ìˆë‹¤ë©´ í•œ ë²ˆì˜ ì¿¼ë¦¬ë¡œ ëë‚¼ ìˆ˜ë„ ìˆì„ ê²ë‹ˆë‹¤.

ì‹¤ì œë¡œ `enabled` ì˜µì…˜ì€ ì¿¼ë¦¬ì˜ ìˆœì„œë¥¼ ì •í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ê¸°ë³´ë‹¤ëŠ” ì–´ë–¤ ì¿¼ë¦¬ë¥¼ ë°”ë¡œ ì‹¤í–‰í•˜ì§€ ì•Šê³  íŠ¹ì •í•œ ê°’ì´ ìˆê±°ë‚˜ íŠ¹ì • ìƒí™©ì´ ë˜ì—ˆì„ ë•Œ ì‹¤í–‰í•˜ë„ë¡ í•˜ëŠ” ë“±, ë‹¤ì–‘í•œ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### `useQuery()`ì—ì„œ `enabled` ê°’ ì‚¬ìš©í•˜ê¸°

ê·¸ëŸ¼ `enabled` ê°’ì„ í™œìš©í•˜ì—¬ ê°„ë‹¨í•œ ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ ë§Œë“¤ì–´ ë´…ì‹œë‹¤. ë¡œê·¸ì¸ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì½”ë“œì‡ì´ë¼ëŠ” ìœ ì €ë¡œ ë¡œê·¸ì¸ë˜ê³ , í•´ë‹¹ ìœ ì €ì˜ ì •ë³´ë¥¼ ë°±ì—”ë“œë¡œë¶€í„° ë°›ì•„ ì™€ì„œ ìœ ì €ì˜ ì´ë¦„ì„ ë³´ì—¬ì£¼ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” `currentUsername`ì´ë¼ëŠ” ìŠ¤í…Œì´íŠ¸ ê°’ì„ ë§Œë“¤ì–´ ì‚¬ìš©í•´ ë³¼ í…ë°ìš”. ë¡œê·¸ì¸ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ `currentUsername`ì„ `'codeit'`ì´ë¼ëŠ” ê°’ìœ¼ë¡œ ì„¤ì •í•˜ê³ , `currentUsername` ê°’ì´ ìˆì„ ë•Œ `userInfo` ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í• ê²Œìš”.

```js
// api.js
const BASE_URL = "https://learn.codeit.kr/api/codestudit";

// ...

export async function getUserInfo(username) {
  const response = await fetch(`${BASE_URL}/users/${username}`);
  return await response.json();
}
```

```js
// HomePage.js
import { useState } from "react";
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import { getPosts, uploadPost, getUserInfo } from "./api";

function HomePage() {
  const [currentUsername, setCurrentUsername] = useState("");

  // ...

  const { data: userInfoData, isPending: isUserInfoPending } = useQuery({
    queryKey: ["userInfo"],
    queryFn: () => getUserInfo(currentUsername),
    enabled: !!currentUsername,
  });

  // ...

  const handleLoginButtonClick = () => {
    setCurrentUsername("codeit");
  };

  const loginMessage = isUserInfoPending
    ? "ë¡œê·¸ì¸ ì¤‘ì…ë‹ˆë‹¤..."
    : `${userInfoData?.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;

  if (isPending) return "ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...";

  if (isError) return "ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";

  const posts = postsData?.results ?? [];

  return (
    <>
      <div>
        {currentUsername ? (
          loginMessage
        ) : (
          <button onClick={handleLoginButtonClick}>codeitìœ¼ë¡œ ë¡œê·¸ì¸</button>
        )}
        <form onSubmit={handleSubmit}>
          <textarea
            name="content"
            value={content}
            onChange={handleInputChange}
          />
          <button disabled={!content} type="submit">
            ì—…ë¡œë“œ
          </button>
        </form>
      </div>
      <div>
        <ul>
          {posts.map((post) => (
            <li key={post.id}>
              {post.user.name}: {post.content}
            </li>
          ))}
        </ul>
      </div>
    </>
  );
}

export default HomePage;
```

ì‹¤í–‰í•´ë³´ë©´ ì²˜ìŒì—ëŠ” `['userInfo']` ì¿¼ë¦¬ê°€ `disabled` ë˜ì–´ ìˆëŠ” ê±¸ í™•ì¸í•  ìˆ˜ ìˆì£ .
![](https://velog.velcdn.com/images/pmj9498/post/1958a934-14b1-4f72-9f9e-3e3c347525d7/image.png)
ë¡œê·¸ì¸ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ `currentUsername`ì´ ì„¤ì •ì´ ë˜ê³ , `['userInfo']` ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ì–´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
![](https://velog.velcdn.com/images/pmj9498/post/3136b021-3db8-48eb-ab21-cccda31ffc0d/image.png)
`userInfo` ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê³  ë‚˜ë©´ ìœ ì € ì´ë¦„ì´ ì˜ ë³´ì´ë„¤ìš”.
![](https://velog.velcdn.com/images/pmj9498/post/132a96a7-e895-46f0-b2f5-9d7377c9d937/image.png)

## âœ” Paginated Query

ì´ë²ˆ ê°•ì˜ì—ì„œëŠ” í˜ì´ì§€ë„¤ì´ì…˜ì„ êµ¬í˜„í•´ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. ê¸°ì¡´ì—ëŠ” ëª¨ë“  í¬ìŠ¤íŠ¸ë¥¼ ë‹¤ í•œ ë²ˆì— ë¶ˆëŸ¬ì™”ì§€ë§Œ ì´ë²ˆì—ëŠ” ì„¸ ê°œì”© ëŠì–´ì„œ ë¶ˆëŸ¬ì˜¤ê³ , ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ê·¸ë‹¤ìŒ ë°ì´í„°ë¥¼ ì„¸ ê°œì”© ë°›ì•„ ì˜¤ë„ë¡ í•˜ë ¤ê³  í•©ë‹ˆë‹¤.

ë¨¼ì € í˜„ì¬ í¬ìŠ¤íŠ¸ë¥¼ ë°›ì•„ì˜¤ëŠ” API í•¨ìˆ˜ë¥¼ `page`ì™€ `limit` ê°’ì„ ë°›ë„ë¡ ë³€ê²½í•´ ì£¼ê² ìŠµë‹ˆë‹¤. ì°¸ê³ ë¡œ ë°±ì—”ë“œ APIì— ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ `page`ì™€ `limit`ë¥¼ ë„˜ê²¨ì£¼ë©´ í•´ë‹¹í•˜ëŠ” `page`ì˜ ë°ì´í„°ë¥¼ `limit` ê°œìˆ˜ë§Œí¼ ë³´ë‚´ì£¼ë„ë¡ ì„¤ê³„ê°€ ë˜ì–´ìˆì–´ìš”.

```js
export async function getPosts(page = 0, limit = 10) {
  const response = await fetch(`${BASE_URL}/posts?page=${page}&limit=${limit}`);
  return await response.json();
}
```

ê·¸ ë‹¤ìŒì—ëŠ” `useState()`ë¥¼ ì‚¬ìš©í•´ `page` ë³€ìˆ˜ë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤. `useQuery()`ì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ `queryKey`ì— `page`ë¥¼ ì¶”ê°€í•´ `page`ë³„ë¡œ ë°ì´í„°ë¥¼ ìºì‹±í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ì¿¼ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ ë¶€ë¶„ì— `page`ë¥¼ ì¶”ê°€í•´ ì¤„ê²Œìš”.

```js
import { useState } from "react";
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import { getPosts, uploadPost, getUserInfo } from "./api";

const PAGE_LIMIT = 3;

function HomePage() {
  // ...

  const [page, setPage] = useState(0);
  const {
    data: postsData,
    isPending,
    isError,
  } = useQuery({
    queryKey: ["posts", page],
    queryFn: () => getPosts(page, PAGE_LIMIT),
  });

  // ...

  const posts = postsData?.results ?? [];

  return (
    <>
      <div>
        {currentUsername ? (
          loginMessage
        ) : (
          <button onClick={handleLoginButtonClick}>codeitìœ¼ë¡œ ë¡œê·¸ì¸</button>
        )}
        <form onSubmit={handleSubmit}>
          <textarea
            name="content"
            value={content}
            onChange={handleInputChange}
          />
          <button disabled={!content} type="submit">
            ì—…ë¡œë“œ
          </button>
        </form>
      </div>
      <div>
        <ul>
          {posts.map((post) => (
            <li key={post.id}>
              {post.user.name}: {post.content}
            </li>
          ))}
        </ul>
      </div>
    </>
  );
}

export default HomePage;
```

![](https://velog.velcdn.com/images/pmj9498/post/54f1c1ba-a7d1-4218-83aa-0c138028fcb4/image.png)
ê²°ê³¼ë¥¼ í™•ì¸í•´ ë³´ë©´ ì´ì œ ì²« í˜ì´ì§€(page ê°’ 0)ì— í•´ë‹¹í•˜ëŠ” ì„¸ ê°œì˜ ë°ì´í„°ë§Œ ë³´ì´ê²Œ ë©ë‹ˆë‹¤.
![](https://velog.velcdn.com/images/pmj9498/post/8194dae6-62d0-4399-9009-6d46260fc335/image.png)
ì´ì œ í˜ì´ì§€ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆê²Œë” ë²„íŠ¼ì„ ì¶”ê°€í•´ ë´…ì‹œë‹¤. ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ ê°œë°œì ë„êµ¬ë¡œ `posts` ë°ì´í„°ë¥¼ ì‚´í´ë³´ë©´ `hasMore`ë¼ëŠ” ê°’ì´ ìˆëŠ”ë°ìš”. ë°±ì—”ë“œì—ì„œ ê·¸ë‹¤ìŒ í˜ì´ì§€ê°€ ìˆì„ ë•Œ `hasMore`ê°’ì„ `true`ë¡œ ë³´ë‚´ ì£¼ê²Œ ë©ë‹ˆë‹¤. ìš°ë¦¬ëŠ” ì´ `hasMore`ë¼ëŠ” ê°’ìœ¼ë¡œ ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ì„ ë¹„í™œì„±í™”í• ì§€ ë§ì§€ë¥¼ ê²°ì •í•  ìˆ˜ ìˆê² ì£ .

```js
import { useState } from "react";
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import { getPosts, uploadPost, getUserInfo } from "./api";

const PAGE_LIMIT = 3;

function HomePage() {
  // ...
  const [page, setPage] = useState(0);
  const {
    data: postsData,
    isPending,
    isError,
  } = useQuery({
    queryKey: ["posts", page],
    queryFn: () => getPosts(page, PAGE_LIMIT),
  });

  // ...

  const posts = postsData?.results ?? [];

  return (
    <>
      <div>
        {currentUsername ? (
          loginMessage
        ) : (
          <button onClick={handleLoginButtonClick}>codeitìœ¼ë¡œ ë¡œê·¸ì¸</button>
        )}
        <form onSubmit={handleSubmit}>
          <textarea
            name="content"
            value={content}
            onChange={handleInputChange}
          />
          <button disabled={!content} type="submit">
            ì—…ë¡œë“œ
          </button>
        </form>
      </div>
      <div>
        <ul>
          {posts.map((post) => (
            <li key={post.id}>
              {post.user.name}: {post.content}
            </li>
          ))}
        </ul>
        <div>
          <button
            disabled={page === 0}
            onClick={() => setPage((old) => Math.max(old - 1, 0))}
          >
            &lt;
          </button>
          <button
            disabled={!postsData?.hasMore}
            onClick={() => setPage((old) => old + 1)}
          >
            &gt;
          </button>
        </div>
      </div>
    </>
  );
}

export default HomePage;
```

![](https://velog.velcdn.com/images/pmj9498/post/42286beb-5f11-4430-b856-3acb785649c7/image.png)
ë§ˆì§€ë§‰ í˜ì´ì§€ë¡œ ê°€ë©´ ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.
![](https://velog.velcdn.com/images/pmj9498/post/92ffbbd9-93db-484e-aecb-ecc41226a008/image.png)
ê·¸ëŸ°ë° ì§€ê¸ˆì€ ë‹¤ìŒ í˜ì´ì§€ë¡œ ë„˜ì–´ê°ˆ ë•Œë§ˆë‹¤ ì•„ë˜ì™€ ê°™ì´ ë§¤ë²ˆ ë¡œë”© ë©”ì‹œì§€ê°€ ëœ¨ëŠ”ë°ìš”. ìƒˆë¡œìš´ í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” ì¿¼ë¦¬ë¥¼ ë³´ë‚¼ ë•Œë§ˆë‹¤ ì™„ì „íˆ ìƒˆë¡œìš´ ì¿¼ë¦¬ë¡œ ì¸ì‹ì„ í•˜ê¸° ë•Œë¬¸ì— ê³„ì† `pending` ìƒíƒœê°€ ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
![](https://velog.velcdn.com/images/pmj9498/post/0719b1dd-63b7-4280-b12a-89df9308d5a9/image.png)
ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ì—ì„œëŠ” ì¢€ ë” ë¶€ë“œëŸ¬ìš´ UI ì „í™˜ì„ ìœ„í•´ `placeholderData` ë¼ëŠ” ê²ƒì„ ì„¤ì •í•´ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. `useQuery()`ì—ì„œ `placeholderData` ì˜µì…˜ì— `keepPreviousData` í˜¹ì€ `(prevData) => prevData`ë¥¼ ë„£ì–´ì£¼ë©´ í˜ì´ì§€ê°€ ìƒˆë¡œ ë°”ë€Œë”ë¼ë„ ë§¤ë²ˆ pending ìƒíƒœê°€ ë˜ì§€ ì•Šê³ , ì´ì „ì˜ ë°ì´í„°ë¥¼ ìœ ì§€í•´ì„œ ë³´ì—¬ì£¼ë‹¤ê°€ ìƒˆë¡œìš´ ë°ì´í„° fetchê°€ ì™„ë£Œë˜ë©´ ìì—°ìŠ¤ëŸ½ê²Œ ìƒˆë¡œìš´ ë°ì´í„°ë¡œ ë°”ê¿”ì„œ ë³´ì—¬ì£¼ê²Œ ë©ë‹ˆë‹¤.

```js
import {
  // ...
  keepPreviousData,
} from "@tanstack/react-query";

const {
  data: postsData,
  isPending,
  isError,
} = useQuery({
  queryKey: ["posts", page],
  queryFn: () => getPosts(page, PAGE_LIMIT),
  placeholderData: keepPreviousData,
});
```

![](https://velog.velcdn.com/images/pmj9498/post/1da0b4f7-fc1b-4ae3-8aa2-f8f489934a05/image.png)
ë‹¤ìŒ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ `fetching` ìƒíƒœì´ì§€ë§Œ ë¡œë”© ë©”ì‹œì§€ê°€ ëœ¨ì§€ ì•Šê³  ì´ì „ í˜ì´ì§€ì˜ ë‚´ìš©ì´ ê·¸ëŒ€ë¡œ ë³´ì…ë‹ˆë‹¤.
![](https://velog.velcdn.com/images/pmj9498/post/f0f70e0c-3a76-4a72-bf67-eecca63824e8/image.png)
ê·¸ëŸ¬ë‹¤ê°€ ë°ì´í„°ë¥¼ ëª¨ë‘ ë°›ì•„ ì˜¤ë©´ ë‹¤ìŒ í˜ì´ì§€ì˜ ë‚´ìš©ìœ¼ë¡œ ë°”ë€ë‹ˆë‹¤.
![](https://velog.velcdn.com/images/pmj9498/post/4ea99ca2-d7ba-4bb4-8438-5385cc6989c2/image.png)
ê·¸ëŸ°ë° ì´ë•Œ ì¤‘ê°„ ê³¼ì •ì—ì„œ ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ì´ í™œì„±í™”ëœ ì±„ë¡œ ìˆëŠ”ë°ìš”. í˜„ì¬ ë³´ì´ëŠ” ë°ì´í„°ê°€ ì´ì „ ë°ì´í„°, ì¦‰ `placeholderData`ë¼ë©´ ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ì„ ë¹„í™œì„±í™”í•´ ì£¼ë„ë¡ í•©ì‹œë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ìœ ì €ê°€ ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ì„ ë§ˆêµ¬ ëˆ„ë¥´ëŠ” ê²½ìš°, ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í˜ì´ì§€ë¡œ ë¦¬í€˜ìŠ¤íŠ¸ê°€ ê°ˆ ìˆ˜ë„ ìˆê¸° ë•Œë¬¸ì´ì—ìš”. `useQuery()`ì˜ ë¦¬í„´ ê°’ì—ì„œ `isPlaceholderData` ê°’ì„ í™œìš©í•˜ë©´ ë©ë‹ˆë‹¤.

```js
const {
  data: postsData,
  isPending,
  isError,
  isPlaceholderData,
} = useQuery({
  queryKey: ['posts', page],
  queryFn: () => getPosts(page, PAGE_LIMIT),
  placeholderData: keepPreviousData,
});

...

return (
  ...
    <div>
    <ul>
      {posts.map((post) => (
        <li key={post.id}>{`${post.user.name}: ${post.content}`}</li>
      ))}
    </ul>
    <div>
      <button
        disabled={page === 0}
        onClick={() => setPage((old) => Math.max(old - 1, 0))}
      >
        &lt;
      </button>
      <button
        disabled={isPlaceholderData || !postsData?.hasMore}
        onClick={() => setPage((old) => old + 1)}
      >
        &gt;
      </button>
    </div>
  </div>

);
```

ì´ë ‡ê²Œ í˜ì´ì§€ë„¤ì´ì…˜ì„ ì™„ì„±í•´ ë³´ì•˜ëŠ”ë°ìš”. ë§Œì•½ ì¢€ ë” ì‹¬ë¦¬ìŠ¤(seamless)í•œ ìœ ì € ì¸í„°í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ê³  ì‹¶ë‹¤ë©´ ë°ì´í„°ë¥¼ prefetchí•˜ëŠ” ë°©ë²•ë„ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì´ ì¿¼ë¦¬ í´ë¼ì´ì–¸íŠ¸ì˜ `prefetchQuery` í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ë©´, í˜„ì¬ ë‚´ê°€ ë³´ê³  ìˆëŠ” í˜ì´ì§€ê°€ 1 í˜ì´ì§€ì—¬ë„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ 2 í˜ì´ì§€ ë°ì´í„°ë¥¼ ë¯¸ë¦¬ fetchí•´ ë†“ê¸° ë•Œë¬¸ì— ë‹¤ìŒ í˜ì´ì§€ë¡œ ê°ˆ ë•Œ ì „í˜€ ì–´ìƒ‰í•¨ì´ë‚˜ ëŠê¹€ì´ ì—†ì´ 2 í˜ì´ì§€ì˜ ë°ì´í„°ë¥¼ ë³´ì—¬ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```js
...

useEffect(() => {
  if (!isPlaceholderData && postsData?.hasMore) {
    queryClient.prefetchQuery({
      queryKey: ['posts', page + 1],
      queryFn: () => getPosts(page + 1, PAGE_LIMIT),
    });
  }
}, [isPlaceholderData, postsData, queryClient, page]);
...
```

![](https://velog.velcdn.com/images/pmj9498/post/e76d9a20-92ef-4be2-aa50-6a51de5f72a3/image.png)

## âœ” Infinite Query

ì´ë²ˆì—ëŠ” í¬ìŠ¤íŠ¸ ëª©ë¡ì—ì„œ í˜ì´ì§€ë„¤ì´ì…˜ ëŒ€ì‹ ì— ë” ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ì„ êµ¬í˜„í•´ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ì—ì„œ ì œê³µí•˜ëŠ” `useInfiniteQuery`ë¥¼ ì´ìš©í•´ì„œ ë” ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ì„ ì‰½ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆëŠ”ë°ìš”. ì–´ë–»ê²Œ í•˜ëŠ”ì§€ ì°¨ê·¼ì°¨ê·¼ ì•Œì•„ë³¼ê²Œìš”.

ë¨¼ì € í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ëŒ€ì‹ , "ë” ë¶ˆëŸ¬ì˜¤ê¸°" ë²„íŠ¼ì„ ë Œë”ë§í• ê²Œìš”.

```js
...

return (
  <>
    <div>
      <form onSubmit={handleSubmit}>
        <textarea
          name='content'
          value={content}
          onChange={handleInputChange}
        />
        <button
          disabled={uploadPostMutation.isPending || !content}
          type='submit'
        >
          ì—…ë¡œë“œ
        </button>
      </form>
    </div>
    <div>
      <ul>
        {posts.map((post) => (
          <li key={post.id}>{`${post.user.id}: ${post.content}`}</li>
        ))}
      </ul>
      <div>
        <button>ë” ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>
  </>
);
```

![](https://velog.velcdn.com/images/pmj9498/post/e82147da-7d93-42d9-8637-3c50c4187b15/image.png)

### `useInfiniteQuery()` ì‚¬ìš©í•˜ê¸°

ì´ì œ ë³¸ê²©ì ìœ¼ë¡œ ë” ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ êµ¬í˜„í•´ ë´…ì‹œë‹¤. ê¸°ì¡´ì— ì‚¬ìš©í•˜ë˜ `useQuery()`ë¥¼ `useInfiniteQuery()`ë¡œ ë°”ê¿” ì¤ì‹œë‹¤. ì´ë•Œ `useQuery()`ì™€ëŠ” ë‹¬ë¦¬ `useInfiniteQuery()`ì—ì„œëŠ” `initialPageParam`ê³¼ `getNextPageParam` ì˜µì…˜ì„ ì„¤ì •í•´ ì¤˜ì•¼ í•˜ëŠ”ë°ìš”. í˜ì´ì§€ë„¤ì´ì…˜ê³¼ëŠ” ë‹¬ë¦¬ í˜ì´ì§€ ë³„ë¡œ ë°ì´í„°ë¥¼ ë³„ë„ë¡œ ì €ì¥í•˜ì§€ ì•Šê³  ì „ì²´ í¬ìŠ¤íŠ¸ë¥¼ í•œ ë²ˆì— ê´€ë¦¬í•  ê²ƒì´ê¸° ë•Œë¬¸ì— ì¿¼ë¦¬ í‚¤ëŠ” ë‹¤ì‹œ `['posts']`ë¡œ ë³€ê²½í•´ ì¤ë‹ˆë‹¤. ì¿¼ë¦¬ í•¨ìˆ˜ë„ `pageParam`ì´ë¼ëŠ” ê°’ì„ ë°›ì•„ì„œ ë°±ì—”ë“œì— ì „ë‹¬í•  í˜ì´ì§€ê°’ìœ¼ë¡œ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½í•´ ì£¼ê² ìŠµë‹ˆë‹¤.

```js
import {
  // ...
  useInfiniteQuery,
} from "@tanstack/react-query";

//

const {
  data: postsData,
  isPending,
  isError,
} = useInfiniteQuery({
  queryKey: ["posts"],
  queryFn: ({ pageParam }) => getPosts(pageParam, PAGE_LIMIT),
  initialPageParam: 0,
  getNextPageParam: (lastPage, allPages, lastPageParam, allPageParams) =>
    lastPage.hasMore ? lastPageParam + 1 : undefined,
});
```

`useInfiniteQuery()`ê°€ ì–´ë–»ê²Œ ë™ì‘í•˜ëŠ”ì§€ ìì„¸íˆ ì•Œì•„ë´…ì‹œë‹¤. `useQuery()`ì—ì„œëŠ” `data`ê°€ ë°±ì—”ë“œì—ì„œ ë°›ì•„ ì˜¨ í•˜ë‚˜ì˜ í˜ì´ì§€ ì •ë³´ë§Œ ë‹´ê³  ìˆì§€ë§Œ, `useInfiniteQuery()`ì—ì„œëŠ” `data.pages`ì— ë°°ì—´ì˜ í˜•íƒœë¡œ ëª¨ë“  í˜ì´ì§€ì˜ ì •ë³´ë¥¼ ë‹´ê³  ìˆê²Œ ë©ë‹ˆë‹¤. í˜ì´ì§€ë„¤ì´ì…˜ì„ ìƒê°í•´ ë³´ë©´, ì²˜ìŒì—” ì²« ë²ˆì§¸ í˜ì´ì§€(0 í˜ì´ì§€)ì˜ ë°ì´í„°ë¥¼ ë°±ì—”ë“œë¡œë¶€í„° ë°›ì•„ì™€ í•´ë‹¹ ë°ì´í„°ë§Œ í™”ë©´ì— ë³´ì—¬ì£¼ê³ , ì²«ë²ˆì§¸ í˜ì´ì§€ì˜ ë°ì´í„°ëŠ” `['posts', 0]`ì˜ ì¿¼ë¦¬ í‚¤ë¡œ ìºì‹±í–ˆì—ˆì£ ? ê·¸ ì´í›„ì— ë‹¤ìŒ í˜ì´ì§€ë¡œ ë„˜ì–´ê°€ë©´ ë‘ ë²ˆì§¸ í˜ì´ì§€(1 í˜ì´ì§€)ì˜ ë°ì´í„°ë¥¼ ë°±ì—”ë“œë¡œë¶€í„° ë°›ì•„ ì™€ ì—­ì‹œ í•´ë‹¹ ë°ì´í„°ë§Œ í™”ë©´ì— ë³´ì—¬ ì£¼ê³ , ë‘ ë²ˆì§¸ í˜ì´ì§€ì˜ ë°ì´í„°ëŠ” `['posts', 1]`ì˜ ì¿¼ë¦¬ í‚¤ë¡œ ìºì‹±í–ˆê³ ìš”.

ê·¸ëŸ°ë° `useInfiniteQuery()`ì—ì„œëŠ” `data.pages` ë¼ëŠ” ë°°ì—´ ì•ˆì— ì§€ê¸ˆê¹Œì§€ ë°›ì•„ ì˜¨ ëª¨ë“  í˜ì´ì§€ì˜ ë°ì´í„°ê°€ ë‹´ê¸°ê²Œ ë©ë‹ˆë‹¤. ë§¨ ì²˜ìŒ ì²« ë²ˆì§¸ í˜ì´ì§€ì˜ ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ë©´ `data.pages` ë°°ì—´ì˜ 0ë²ˆ ì¸ë±ìŠ¤ì— í•´ë‹¹ ë°ì´í„°ê°€ ì €ì¥ë˜ê³ , ë‘ ë²ˆì§¸ í˜ì´ì§€ë¡œ ë„˜ì–´ê°€ë©´ `data.pages` ë°°ì—´ì˜ 1ë²ˆ ì¸ë±ìŠ¤ì— ë°ì´í„°ê°€ ì €ì¥ë˜ëŠ” ì‹ì´ì—ìš”. í•˜ë‚˜ì˜ ë°°ì—´ì— ë‘ í˜ì´ì§€ì˜ ë°ì´í„°ë“¤ì´ ëª¨ë‘ ë‹´ê²¨ìˆìœ¼ë¯€ë¡œ ì²« ë²ˆì§¸ì™€ ë‘ ë²ˆì§¸ ë°ì´í„°ë¥¼ í•œ ë²ˆì— í™”ë©´ì— ë³´ì—¬ ì¤„ ìˆ˜ ìˆëŠ”ë°ìš”. ì´ëŸ° ì‹ìœ¼ë¡œ ë” ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë°ì´í„°ë“¤ì€ `['posts']`ë¼ëŠ” í•˜ë‚˜ì˜ ì¿¼ë¦¬ í‚¤ë¡œ ìºì‹±ë©ë‹ˆë‹¤.

### `pageParam` ì‚¬ìš©í•˜ê¸°

```js
initialPageParam: 0,
getNextPageParam: (lastPage, allPages, lastPageParam, allPageParams) =>
  lastPage.hasMore ? lastPageParam + 1 : undefined,
```

ì´ë•Œ, `initialPageParam`ìœ¼ë¡œëŠ” ì´ˆê¸° í˜ì´ì§€ ì„¤ì •ê°’ì„ ì •í•˜ê²Œ ë˜ëŠ”ë°ìš”. ìš°ë¦¬ê°€ ì‚¬ìš©í•˜ëŠ” APIì—ì„œëŠ” 0 í˜ì´ì§€ê°€ ì´ˆê¸° í˜ì´ì§€ë‹ˆê¹Œ ê°’ì„ 0ìœ¼ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.

ê·¸ë¦¬ê³  `getNextPageParam()` í•¨ìˆ˜ë¡œëŠ” ë‹¤ìŒ í˜ì´ì§€ì˜ ì„¤ì •ê°’ì„ ì •í•˜ê²Œ ë©ë‹ˆë‹¤. `getNextPageParam()`ì€ `lastPage`, `allPages`, `lastPageParam`, `allPageParams`ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ë°›ëŠ”ë°ìš”. `lastPage`ëŠ” í˜„ì¬ê¹Œì§€ ì¤‘ ê°€ì¥ ë§ˆì§€ë§‰ í˜ì´ì§€ì˜ ë°ì´í„°ê°€ ì „ë‹¬ë©ë‹ˆë‹¤. ë§Œì•½ í˜„ì¬ 2 í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê¹Œì§€ ë°›ì•„ ì™”ë‹¤ë©´ 2 í˜ì´ì§€ì˜ ë°ì´í„°ê°€ `lastPage`ë¡œ ì „ë‹¬ë˜ê² ì£ . `allPages`ë¡œëŠ” ëª¨ë“  í˜ì´ì§€ì˜ ë°ì´í„°ê°€ ì „ë‹¬ë˜ê³ ìš”. `lastPageParam`ì€ í˜„ì¬ê¹Œì§€ ì¤‘ ê°€ì¥ ë§ˆì§€ë§‰ í˜ì´ì§€ì˜ ì„¤ì •ê°’ì„ ë§í•˜ëŠ”ë°ìš”. ì¦‰ í˜„ì¬ 2 í˜ì´ì§€ê¹Œì§€ ë°›ì•„ ì™”ë‹¤ë©´ `lastPageParam`ì€ 2ê°€ ë©ë‹ˆë‹¤. `allPageParams`ëŠ” ëª¨ë“  í˜ì´ì§€ì˜ ê°ê°ì˜ í˜ì´ì§€ ì„¤ì •ê°’ì„ ê°€ì§€ê³  ìˆê²Œ ë˜ê³ ìš”.

`getNextPageParam()`ì—ì„œëŠ” íŒŒë¼ë¯¸í„°ë¡œ ë°›ì€ ê°’ë“¤ì˜ ì •ë³´ë¥¼ ì´ìš©í•´ ê·¸ë‹¤ìŒ í˜ì´ì§€ ê°’ì¸ `pageParam`ì„ ë¦¬í„´í•´ì•¼ í•©ë‹ˆë‹¤. ì´ í”„ë¡œì íŠ¸ì˜ ê²½ìš° í˜„ì¬ 0 í˜ì´ì§€ë¼ë©´ ê·¸ë‹¤ìŒ ê°’ì€ 1ì´ ë˜ì–´ì•¼ í•  í…ë°ìš”. ë”°ë¼ì„œ 0 í˜ì´ì§€ì˜ ë°ì´í„°ì—ì„œ `hasMore` ê°’ì„ í™•ì¸ í›„, `true`ì¸ ê²½ìš° `lastPageParam`ì˜ ê°’ì¸ 0ì— 1ì„ ë”í•œ ê°’ 1ì„ ë¦¬í„´í•˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤. `false`ì¸ ê²½ìš° `undefined`ë‚˜ `null`ì„ ë¦¬í„´í•´ ì£¼ë©´ ë˜ëŠ”ë°, ì´ëŠ” ë‹¤ìŒ í˜ì´ì§€ê°€ ì—†ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

ì´ `pageParam` ê°’ì€ ì¿¼ë¦¬ í•¨ìˆ˜ì˜ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ë˜ë¯€ë¡œ, ì´ ê°’ì„ ì´ìš©í•´ ë°±ì—”ë“œì— í•´ë‹¹ í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì¿¼ë¦¬ í•¨ìˆ˜ë¥¼ ì•„ë˜ì²˜ëŸ¼ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ê²ƒì´ì£ .

```js
queryFn: ({ pageParam }) => getPosts(pageParam, PAGE_LIMIT);
```

ìœ„ì²˜ëŸ¼ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ê³  ì‹¤í–‰í•´ ë³´ë©´, ì•„ë˜ì²˜ëŸ¼ `['posts']` ì¿¼ë¦¬ í‚¤ì— ë‹¤ìŒê³¼ ê°™ì´ `pages` ë°°ì—´ì˜ 0ë²ˆ ì¸ë±ìŠ¤ì—ëŠ” ì²« ë²ˆì§¸ í˜ì´ì§€(0 í˜ì´ì§€)ì˜ ë°ì´í„°ê°€, `pageParams` ë°°ì—´ì˜ 0ë²ˆ ì¸ë±ìŠ¤ì—ëŠ” ì²« ë²ˆì§¸ í˜ì´ì§€ê°’ì¸ 0ì´ ë“¤ì–´ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](https://velog.velcdn.com/images/pmj9498/post/1fca8fbf-ada7-43ee-9217-b1c7ce418355/image.png)

### ë‹¤ìŒ í˜ì´ì§€ ë¶ˆëŸ¬ì˜¤ê¸°

ë‹¤ìŒ í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ `useInfiniteQuery()`ì˜ ë¦¬í„´ ê°’ ì¤‘ í•˜ë‚˜ì¸ `fetchNextPage()` í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ë©´ ë˜ëŠ”ë°ìš”. `fetchNextPage()` í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ë©´ `getNextPageParam()` í•¨ìˆ˜ì˜ ë¦¬í„´ ê°’ì´ `undefined`ë‚˜ `null`ì´ ì•„ë‹Œ ê²½ìš°, í•´ë‹¹ ë¦¬í„´ ê°’ì„ ì¿¼ë¦¬ í•¨ìˆ˜ì˜ `pageParam`ìœ¼ë¡œ ì „ë‹¬í•´ ê·¸ë‹¤ìŒ í˜ì´ì§€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. ë”°ë¼ì„œ ìš°ë¦¬ëŠ” "ë” ë¶ˆëŸ¬ì˜¤ê¸°" ë²„íŠ¼ì˜ `onClick()` í•¨ìˆ˜ë¡œ `fetchNextPage()` í•¨ìˆ˜ë¥¼ ë“±ë¡í•´ ì£¼ë©´ ë˜ê² ì£ .

```js
const {
  data: postsData,
  isPending,
  isError,
  fetchNextPage,
} = useInfiniteQuery({
  queryKey: ['posts'],
  queryFn: ({ pageParam }) => getPosts(pageParam, PAGE_LIMIT),
  initialPageParam: 0,
  getNextPageParam: (lastPage, allPages, lastPageParam, allPageParams) =>
    lastPage.hasMore ? lastPageParam + 1 : undefined,
});

// ...

return (
  ...
    <div>
      <button onClick={fetchNextPage}>ë” ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>
  ...
);
```

### í˜ì´ì§€ ë°ì´í„°ë¥¼ êµ¬ì¡°ì— ë§ê²Œ ì •ë¦¬í•˜ê¸°

ì´ì œ ìƒˆë¡œìš´ ë°ì´í„° êµ¬ì¡°ì— ë§ê²Œ í¬ìŠ¤íŠ¸ë“¤ì„ ì œëŒ€ë¡œ ë³´ì—¬ ì¤„ê²Œìš”. ê¸°ì¡´ì—ëŠ” `postsData`ì— í˜ì´ì§€ í•˜ë‚˜ì— í•´ë‹¹í•˜ëŠ” í¬ìŠ¤íŠ¸ ë°ì´í„°ë§Œ ë“¤ì–´ ìˆì—ˆëŠ”ë°ìš”. ì´ì œëŠ” `postsData` ì•ˆì— `pages`ë¼ëŠ” ë°°ì—´ì— ëª¨ë“  í˜ì´ì§€ì˜ í¬ìŠ¤íŠ¸ ë°ì´í„°ê°€ ë‹´ê²¨ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ `pages` ë°°ì—´ì„ `Array.map()` í•¨ìˆ˜ë¥¼ í†µí•´ ëŒë©´ì„œ, ê° í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” í¬ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ëª¨ë‘ ë³´ì—¬ ì£¼ë„ë¡ ë³€ê²½í•´ ë³¼ê²Œìš”. `Post` ì»´í¬ë„ŒíŠ¸ë¥¼ ìƒˆë¡œ ë§Œë“¤ì–´ í¬ìŠ¤íŠ¸ ê´€ë ¨ ë‚´ìš©ì€ í•´ë‹¹ ì»´í¬ë„ŒíŠ¸ë¡œ ì˜®ê²¨ì£¼ì—ˆìŠµë‹ˆë‹¤.

```js
// ...

const postsPages = postsData?.pages ?? [];

return (
    ...
        <div>
      <ul>
        {postsPages.map((postPage) =>
          postPage.results.map((post) => <Post key={post.id} post={post} />)
        )}
      </ul>
    <div>
    ...
);
```

```js
function Post({ post }) {
  return (
    <li key={post.id}>
      {post.user.name}: {post.content}
    </li>
  );
}

export default Post;
```

ê·¸ëŸ¬ë©´ ë²„íŠ¼ì„ í´ë¦­í•  ë•Œë§ˆë‹¤ ë‹¤ìŒê³¼ ê°™ì´ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ì„¸ ê°œì”© ë¶ˆëŸ¬ì™€ì„œ ì˜ ë³´ì—¬ ì£¼ëŠ” ê±¸ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](https://velog.velcdn.com/images/pmj9498/post/c7c23de9-697c-41bb-8391-719f23e1d4cf/image.png)
ë” ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì„¸ ê°œì”© ë¶ˆëŸ¬ì˜¤ì£ ?
![](https://velog.velcdn.com/images/pmj9498/post/844e70bd-33e6-4acf-bfdc-03ef8b7a8e79/image.png)

### ë²„íŠ¼ ë¹„í™œì„±í™” ì²˜ë¦¬í•˜ê¸°

ë§ˆì§€ë§‰ìœ¼ë¡œ, ë” ì´ìƒ ë¶ˆëŸ¬ì˜¬ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ë‹¤ìŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì¼ ë•Œì—ëŠ” "ë” ë¶ˆëŸ¬ì˜¤ê¸°" ë²„íŠ¼ì„ ë¹„í™œì„±í™”í•˜ê² ìŠµë‹ˆë‹¤. `useInfiniteQuery()`ì˜ ë¦¬í„´ ê°’ ì¤‘ `hasNextPage`ì™€ `isFetchingNextPage`ë¥¼ ì´ìš©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ê°„ë‹¨íˆ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```js
const {
  data: postsData,
  isPending,
  isError,
  hasNextPage,
  fetchNextPage,
  isFetchingNextPage,
} = useInfiniteQuery({
  queryKey: ['posts'],
  queryFn: ({ pageParam }) => getPosts(pageParam, PAGE_LIMIT),
  initialPageParam: 0,
  getNextPageParam: (lastPage, allPages, lastPageParam, allPageParams) =>
    lastPage.hasMore ? lastPageParam + 1 : undefined,
});

// ...

return (
    ...
        <button
      onClick={fetchNextPage}
      disabled={!hasNextPage || isFetchingNextPage}
    >
      ë” ë¶ˆëŸ¬ì˜¤ê¸°
    </button>
    ...
);
```

![](https://velog.velcdn.com/images/pmj9498/post/00016e45-40c9-4583-9541-aa0f06884285/image.png)
ë‹¤ìŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ë©´ ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.
![](https://velog.velcdn.com/images/pmj9498/post/121f988b-76bd-47ed-9986-c206f5df7cab/image.png)
ë” ì´ìƒ ë¶ˆëŸ¬ì˜¬ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.

## âœ” Optimistic Updates

### ì˜µí‹°ë¯¸ìŠ¤í‹± ì—…ë°ì´íŠ¸ë€?

ë¨¼ì € ì˜µí‹°ë¯¸ìŠ¤í‹± ì—…ë°ì´íŠ¸ë€ ë¬´ì—‡ì¼ê¹Œìš”? ìš°ë¦¬ê°€ í‰ì†Œ ì‚¬ìš©í•˜ëŠ” SNSë¥¼ ìƒê°í•´ ë´…ì‹œë‹¤. ìš°ë¦¬ëŠ” ìŠ¤í¬ë¡¤ì„ ë°‘ìœ¼ë¡œ íœ™íœ™ ë„˜ê¸°ë©° ë§ˆìŒì— ë“œëŠ” í¬ìŠ¤íŠ¸ê°€ ìˆë‹¤ë©´ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ê³  ê¸ˆë°© ë‹¤ë¥¸ í¬ìŠ¤íŠ¸ë¡œ ë„˜ì–´ê°€ê³¤ í•©ë‹ˆë‹¤. ê·¸ëŸ°ë° ë§Œì•½ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ 1~2ì´ˆ ë¡œë”© ì‹œê°„ì´ ê±¸ë¦°ë‹¤ë©´ ì–´ë–¨ê¹Œìš”? ì•„ë§ˆ ë§¤ë²ˆ ë‹µë‹µí•œ ë§ˆìŒì´ ë“¤ê² ì£ .

ì˜µí‹°ë¯¸ìŠ¤í‹± ì—…ë°ì´íŠ¸ëŠ” ì¢‹ì•„ìš” ê¸°ëŠ¥ê³¼ ê°™ì´ ìœ ì €ì—ê²Œ ë¹ ë¥¸ í”¼ë“œë°±ì„ ì œê³µí•´ì•¼ í•˜ëŠ” ê²½ìš°ì— ì‚¬ìš©í•©ë‹ˆë‹¤. ê°„ë‹¨íˆ ë§í•˜ìë©´ ì„œë²„ë¡œë¶€í„°ì˜ ë¦¬ìŠ¤í°ìŠ¤ë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ìœ ì €ì—ê²Œ ë°”ë¡œ ë‚™ê´€ì ì¸ í”¼ë“œë°±ì„ ì£¼ëŠ” ê²ƒì´ ì˜µí‹°ë¯¸ìŠ¤í‹± ì—…ë°ì´íŠ¸ì¸ë°ìš”. ì„œë²„ê°€ ì œëŒ€ë¡œ ë™ì‘í•˜ëŠ” ê±¸ ë‚™ê´€ì ìœ¼ë¡œ ê¸°ëŒ€í•˜ëŠ” ê²ƒì´ì£ . ì˜ˆë¥¼ ë“¤ì–´ 'ì¢‹ì•„ìš”' ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì‹¤ì œë¡œ ì„œë²„ì— ë°˜ì˜ì´ ì œëŒ€ë¡œ ë˜ì—ˆëŠ”ì§€ë¥¼ í™•ì¸í•˜ì§€ ì•Šê³  ìœ ì €ì—ê²Œ ë°”ë¡œ 'ì¢‹ì•„ìš”' ë²„íŠ¼ì„ ëˆ„ë¥¸ ê²ƒì²˜ëŸ¼ ë²„íŠ¼ì„ í™œì„±í™”í•´ì„œ ë³´ì—¬ì£¼ëŠ” ê±°ì£ .

ì´ë ‡ê²Œ í•´ë„ ê´œì°®ì€ ì´ìœ ëŠ” ë¦¬í€˜ìŠ¤íŠ¸ëŠ” ë³´í†µ 99% ì´ìƒì˜ í™•ë¥ ë¡œ ì„œë²„ì— ì œëŒ€ë¡œ ë°˜ì˜ë  ê²ƒì´ê³ , ë˜í•œ ë§Œì— í•˜ë‚˜ ì¤‘ê°„ì— ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤ê³  í•´ë„ ì¹˜ëª…ì ì¸ ê²°í•¨ì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì•„ë§ˆ ê²½í—˜í•˜ì…¨ì„ ìˆ˜ë„ ìˆê² ì§€ë§Œ, ë‚´ê°€ ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ë˜ í¬ìŠ¤íŠ¸ë¥¼ ë‚˜ì¤‘ì— ë´¤ì„ ë•Œ ì¢‹ì•„ìš”ê°€ ì•ˆ ë¼ ìˆë‹¤ë©´ ë³´í†µì€ "ì–´ë¼? ë‚´ê°€ ì´ê±° ì¢‹ì•„ìš” ì•ˆ ëˆŒë €ì—ˆë‚˜?"í•˜ë©´ì„œ ë‹¤ì‹œ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ë©´ ê·¸ë§Œì´ë‹ˆê¹Œìš”. ë”°ë¼ì„œ ì´ëŸ¬í•œ ìƒí™©ì—ì„œëŠ” ë§¤ë²ˆ ì„œë²„ì˜ ë¦¬ìŠ¤í°ìŠ¤ë¥¼ ê¸°ë‹¤ë¦¬ëŠë¼ ìœ ì €ì—ê²Œ ë‹µë‹µí•¨ì„ ì£¼ê¸°ë³´ë‹¤ëŠ” ì˜µí‹°ë¯¸ìŠ¤í‹± ì—…ë°ì´íŠ¸ë¥¼ ì´ìš©í•´ ë¹ ë¥¸ í”¼ë“œë°±ì„ ì œê³µí•˜ëŠ” ê²ƒì´ ë” ì¢‹ìŠµë‹ˆë‹¤.

### ì˜µí‹°ë¯¸ìŠ¤í‹± ì—…ë°ì´íŠ¸ë¡œ ì¢‹ì•„ìš” êµ¬í˜„í•˜ê¸°

ê·¸ëŸ¼ ìš°ë¦¬ë„ ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ì˜ í›…ë“¤ì„ ì´ìš©í•´ ì˜µí‹°ë¯¸ìŠ¤í‹± ì—…ë°ì´íŠ¸ë¡œ ì¢‹ì•„ìš” ê¸°ëŠ¥ì„ êµ¬í˜„í•´ ë´…ì‹œë‹¤. `useMutation()`ì˜ ë‹¤ì–‘í•œ ì½œë°±ì„ ì´ìš©í•´ êµ¬í˜„í•´ ë³¼ í…ë°ìš”. ì‹¤ì œ ë®¤í…Œì´ì…˜ ë¦¬í€˜ìŠ¤íŠ¸ë¥¼ ë³´ë‚´ê¸° ì „ì— ê¸°ì¡´ì˜ ìºì‹œ ë°ì´í„°ë¥¼ ì¡°ì‘í•´ì„œ ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ë°˜ì˜í•´ ìœ ì €ì—ê²Œ ë¨¼ì € ë³´ì—¬ì£¼ê³ , ê·¸ ì´í›„ì— ë®¤í…Œì´ì…˜ì´ ëë‚˜ë©´ ì„œë²„ì— ë°˜ì˜ëœ ë°ì´í„°ë¥¼ refetchí•´ì„œ ìµœì‹  ë°ì´í„°ë¡œ ë™ê¸°í™”í•´ ì£¼ê² ìŠµë‹ˆë‹¤.

ë¨¼ì € í¬ìŠ¤íŠ¸ì˜ ì¢‹ì•„ìš” ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ëŠ” API í•¨ìˆ˜ì™€ íŠ¹ì • í¬ìŠ¤íŠ¸ì— ì¢‹ì•„ìš”, ì¢‹ì•„ìš” ì·¨ì†Œë¥¼ ì‹¤í–‰í•˜ëŠ” API í•¨ìˆ˜ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.

```js
// ...

export async function getLikeCountByPostId(postId) {
  const response = await fetch(`${BASE_URL}/posts/${postId}/likes`);
  const body = await response.json();
  return body.count;
}

export async function getLikeStatusByUsername(postId, username) {
  const response = await fetch(`${BASE_URL}/posts/${postId}/likes/${username}`);
  if (response.status === 200) {
    return true;
  } else if (response.status === 404) {
    return false;
  } else {
    throw new Error("Failed to get like status of the post.");
  }
}

export async function likePost(postId, username) {
  const response = await fetch(
    `${BASE_URL}/posts/${postId}/likes/${username}`,
    {
      method: "POST",
    }
  );

  if (!response.ok) {
    throw new Error("Failed to like the post.");
  }
}

export async function unlikePost(postId, username) {
  const response = await fetch(
    `${BASE_URL}/posts/${postId}/likes/${username}`,
    {
      method: "DELETE",
    }
  );

  if (!response.ok) {
    throw new Error("Failed to unlike the post.");
  }
}
```

ì¢‹ì•„ìš” ë°ì´í„°ëŠ” í¬ìŠ¤íŠ¸ ë§ˆë‹¤ ë°›ì•„ ì˜¬ ê±´ë°ìš”.

```js
...

return (
    ...
        <ul>
      {postPages.map((postPage) =>
        postPage.results.map((post) => (
          <Post
            key={post.id}
            post={post}
            currentUsername={currentUsername}
          />
        ))
      )}
    </ul>
    ...
);
```

ë‹¤ìŒê³¼ê°™ì´ `Post` ì»´í¬ë„ŒíŠ¸ ì•ˆì—ì„œ ì¢‹ì•„ìš” ê°œìˆ˜ì™€ í˜„ì¬ ìœ ì €ì˜ ì¢‹ì•„ìš” ì—¬ë¶€ì— ëŒ€í•œ ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ëŠ” `useQuery()`ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. í¬ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì´ìš©í•´ ë‹¤ìŒê³¼ê°™ì´ ì¢‹ì•„ìš” ë²„íŠ¼ì´ ëˆŒë¦° ìƒíƒœì™€ ì¢‹ì•„ìš” ê°œìˆ˜ë¥¼ ë³´ì—¬ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```js
import { useQuery } from "@tanstack/react-query";
import { getLikeCountByPostId } from "./api";

function Post({ post, currentUsername }) {
  const { data: likeCount } = useQuery({
    queryKey: ["likeCount", post.id],
    queryFn: () => getLikeCountByPostId(post.id),
  });

  const { data: isPostLikedByCurrentUser } = useQuery({
    queryKey: ["likeStatus", post.id, currentUsername],
    queryFn: () => getLikeStatusByUsername(post.id, currentUsername),
    enabled: !!currentUsername,
  });

  return (
    <li>
      <div>
        {post.user.name}: {post.content}
      </div>
      <button>
        {isPostLikedByCurrentUser ? "â™¥ï¸ " : "â™¡ "}
        {`ì¢‹ì•„ìš” ${likeCount ?? 0}ê°œ`}
      </button>
    </li>
  );
}

export default Post;
```

![](https://velog.velcdn.com/images/pmj9498/post/b6717fd3-7d40-474a-b564-efe9f10a6629/image.png)
ì¢‹ì•„ìš” ê°œìˆ˜ê°€ ì œëŒ€ë¡œ ë³´ì´ê³ , ì¢‹ì•„ìš” ë²„íŠ¼ì„ ëˆ„ë¥¸ ìœ ì €ë¡œ ë¡œê·¸ì¸í•˜ë©´ ë²„íŠ¼ì´ í™œì„±í™”ëœ ìƒíƒœë¡œ ì˜ ë³´ì…ë‹ˆë‹¤.
![](https://velog.velcdn.com/images/pmj9498/post/f43580a3-3415-4efb-9c6a-862182e39288/image.png)

ì´ì œ `useMutation()`ì„ í™œìš©í•´ ì¢‹ì•„ìš” ê¸°ëŠ¥ì„ ì˜µí‹°ë¯¸ìŠ¤í‹± ì—…ë°ì´íŠ¸ë¡œ êµ¬í˜„í•´ ë´…ì‹œë‹¤. `useMutation()`ì˜ `onMutate`, `onError`, `onSettled`ë¥¼ í™œìš©í•´ì„œ êµ¬í˜„í•  ìˆ˜ ìˆëŠ”ë°ìš”.

ë¨¼ì € ë®¤í…Œì´ì…˜ í•¨ìˆ˜ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ìœ ì €ê°€ likeë¥¼ í–ˆëŠ”ì§€ unlikeë¥¼ í–ˆëŠ”ì§€ì— ë”°ë¼ ê°ê°ì— ë§ëŠ” API í•¨ìˆ˜ë¥¼ ë¶ˆëŸ¬ ì£¼ëŠ” í•¨ìˆ˜ë¥¼ ì •ì˜í•´ ì¤ë‹ˆë‹¤.

```js
import {
  getLikeCountByPostId,
  getLikeStatusByUsername,
  likePost,
  unlikePost,
} from "./api";

// ...

const likesMutation = useMutation({
  mutationFn: async ({ postId, username, userAction }) => {
    if (userAction === "LIKE_POST") {
      await likePost(postId, username);
    } else {
      await unlikePost(postId, username);
    }
  },
});
```

ê·¸ë¦¬ê³  `onMutate` ì˜µì…˜ì„ ì¶”ê°€í•´ ì£¼ëŠ”ë°ìš”. `onMutate`ëŠ” ë®¤í…Œì´ì…˜ í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ê¸° ë°”ë¡œ ì „ì— ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. ì—¬ê¸°ì„œ ìš°ì„  ì¢‹ì•„ìš” ë°ì´í„°ë¥¼ refetchí•˜ëŠ” ê²ƒì„ ë§‰ê¸° ìœ„í•´ `cancelQueries()`ë¥¼ ì‹¤í–‰í•´ì„œ ì¢‹ì•„ìš” ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ëŠ” ì¿¼ë¦¬ê°€ ì‹¤í–‰ ì¤‘ì´ë¼ë©´ ì·¨ì†Œí•´ ì£¼ë„ë¡ í•©ë‹ˆë‹¤. ë°ì´í„°ê°€ refetchë˜ì–´ì„œ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ê²°ê³¼ë¥¼ ë®ì–´ ì“°ëŠ” ê±¸ ë°©ì§€í•˜ê¸° ìœ„í•´ì„œì˜ˆìš”. ì´ë•Œ, í˜„ì¬ ì¢‹ì•„ìš” ìƒíƒœì™€ ì¢‹ì•„ìš” ê°œìˆ˜ì— ëŒ€í•œ ë°ì´í„°ë¥¼ ë‘˜ ë‹¤ ë³€ê²½í•  ì˜ˆì •ì´ë¯€ë¡œ, ê°ê°ì˜ ë°ì´í„°ì— ëŒ€í•œ ì¿¼ë¦¬ë¥¼ ì·¨ì†Œí•´ ì¤„ê²Œìš”.

```js
const queryClient = useQueryClient();

// ...

const likesMutation = useMutation({
  mutationFn: ...
    onMutate: async ({ postId, username, userAction }) => {
    await queryClient.cancelQueries({ queryKey: ['likeStatus', postId, username] });
    await queryClient.cancelQueries({ queryKey: ['likeCount', postId] });
  },
});
```

í˜„ì¬ì˜ ì¢‹ì•„ìš”ì— ëŒ€í•œ ì¿¼ë¦¬ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ìœ ì €ì˜ ì•¡ì…˜ì— ë”°ë¼ í•´ë‹¹ ë°ì´í„°ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤. ê·¸ì „ì— ê¸°ì¡´ì˜ ì¿¼ë¦¬ ë°ì´í„°ë„ ë”°ë¡œ ì €ì¥í•´ ì¤„í…ë°ìš”. ì´ëŠ” ë®¤í…Œì´ì…˜ ì‹¤í–‰ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ ì´ì „ì˜ ë°ì´í„°ë¡œ ë¡¤ë°±í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•  ê±°ì˜ˆìš”.

```js
const queryClient = useQueryClient();

// ...

const likesMutation = useMutation({
  mutationFn: ...,
    onMutate: async ({ postId, username, userAction }) => {
    await queryClient.cancelQueries({
      queryKey: ['likeStatus', postId, username],
    });
    await queryClient.cancelQueries({ queryKey: ['likeCount', postId] });

    const prevLikeStatus = queryClient.getQueryData([
      'likeStatus',
      postId,
      username,
    ]);
    const prevLikeCount = queryClient.getQueryData(['likeCount', postId]);

    queryClient.setQueryData(
      ['likeStatus', postId, username],
      () => userAction === 'LIKE_POST'
    );
    queryClient.setQueryData(['likeCount', postId], (prev) =>
      userAction === 'LIKE_POST' ? prev + 1 : prev - 1
    );
  },
});
```

ë§ˆì§€ë§‰ìœ¼ë¡œ ìˆ˜ì •í•˜ê¸° ì „ì˜ ë°ì´í„°ë¥¼ ë¦¬í„´í•´ ì¤ë‹ˆë‹¤. ì•ì„œ ì„¤ëª…í–ˆë“¯ì´ ë§Œì•½ ë®¤í…Œì´ì…˜ ì¤‘ì— ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ ì´ì „ì˜ ë°ì´í„°ë¡œ ë¡¤ë°±í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

```js
const queryClient = useQueryClient();

// ...

const likesMutation = useMutation({
  mutationFn: ...,
    onMutate: async ({ postId, username, userAction }) => {
    await queryClient.cancelQueries({
      queryKey: ['likeStatus', postId, username],
    });
    await queryClient.cancelQueries({ queryKey: ['likeCount', postId] });

    const prevLikeStatus = queryClient.getQueryData([
      'likeStatus',
      postId,
      username,
    ]);
    const prevLikeCount = queryClient.getQueryData(['likeCount', postId]);

    queryClient.setQueryData(
      ['likeStatus', postId, username],
      () => userAction === 'LIKE_POST'
    );
    queryClient.setQueryData(['likeCount', postId], (prev) =>
      userAction === 'LIKE_POST' ? prev + 1 : prev - 1
    );

    return { prevLikeStatus, prevLikeCount };
  },
});
```

ì´ì œ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ ì´ì „ì˜ ë°ì´í„°ë¡œ ë¡¤ë°±í•˜ëŠ” ë¶€ë¶„ì„ `onError`ì— ì¶”ê°€í•´ ì¤ì‹œë‹¤. `onError`ì—ì„œëŠ” ì„¸ ë²ˆì§¸ íŒŒë¼ë¯¸í„°ë¡œ `context`ë¥¼ ë°›ì•„ì˜¤ëŠ”ë°, ì´ `context`ì— ìš°ë¦¬ê°€ `onMutate`ì—ì„œ ë¦¬í„´í•œ ë°ì´í„°ê°€ ë“¤ì–´ ìˆëŠ”ë°ìš”. ì´ê±¸ë¡œ í•´ë‹¹ í¬ìŠ¤íŠ¸ì˜ ì¢‹ì•„ìš” ë°ì´í„°ë¥¼ ì´ì „ ë°ì´í„°ë¡œ ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```js
const likesMutation = useMutation({
  mutationFn: ...,
    onMutate: async ({ postId, username, userAction }) => {
    // ...
    return { prevLikeStatus, prevLikeCount };
  },
    onError: (err, { postId, username }, context) => {
    queryClient.setQueryData(
      ['likeStatus', postId, username],
      context.prevLikeStatus
    );
    queryClient.setQueryData(['likeCount', postId], context.prevLikeCount);
  },
});
```

ë§ˆì§€ë§‰ìœ¼ë¡œ ì œëŒ€ë¡œ ëœ ì„œë²„ ë°ì´í„°ë¡œ ë™ê¸°í™”í•˜ê¸° ìœ„í•´ ì„±ê³µê³¼ ì‹¤íŒ¨ ì—¬ë¶€ì— ìƒê´€ì—†ì´ `invalidateQueries()` í•¨ìˆ˜ë¡œ ë°ì´í„°ë¥¼ refetchí•˜ê² ìŠµë‹ˆë‹¤. ì°¸ê³ ë¡œ `onSettled`ëŠ” ì„±ê³µ, ì‹¤íŒ¨ ì—¬ë¶€ì— ìƒê´€ì—†ì´ í•­ìƒ ì‹¤í–‰ë©ë‹ˆë‹¤.

```js
const likesMutation = useMutation({
  mutationFn: ...,
    onMutate: ... ,
    onError: ...,
    onSettled: (data, err, { postId, username }) => {
    queryClient.invalidateQueries({
      queryKey: ['likeStatus', postId, username],
    });
        queryClient.invalidateQueries({
      queryKey: ['likeCount', postId],
    });
  },
});
```

ë§ˆì§€ë§‰ìœ¼ë¡œ ì¢‹ì•„ìš” ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ `likesMutation`ì„ ì‹¤í–‰í•˜ë„ë¡ ë‹¤ìŒê³¼ ê°™ì´ ì½”ë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.

```js
const handleLikeButtonClick = (userAction) => {
  if (!currentUsername) return; //ë¡œê·¸ì¸ì´ ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ë®¤í…Œì´ì…˜ì„ ì‹¤í–‰í•˜ì§€ ì•Šê²Œ ë¦¬í„´í•œë‹¤.
  likesMutation.mutate({
    postId: post.id,
    username: currentUsername,
    userAction,
  });
};

return (
  <li>
    <div>
      {post.user.name}: {post.content}
    </div>
    <button
      onClick={() =>
        handleLikeButtonClick(
          isPostLikedByCurrentUser ? "UNLIKE_POST" : "LIKE_POST"
        )
      }
    >
      {isPostLikedByCurrentUser ? "â™¥ï¸ " : "â™¡ "}
      {`ì¢‹ì•„ìš” ${likeCount ?? 0}ê°œ`}
    </button>
  </li>
);
```

ì¢‹ì•„ìš” ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ë©´ ì˜µí‹°ë¯¸ìŠ¤í‹± ì—…ë°ì´íŠ¸ê°€ ì œëŒ€ë¡œ ë™ì‘í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í¬ë¡¬ ê°œë°œì ë„êµ¬ì—ì„œ ë„¤íŠ¸ì›Œí¬ íƒ­ì„ ì¼œ ë†“ê³  Slow 3Gë¡œ ì„¤ì •í•´ì„œ ë³´ë©´ ë” ì˜ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”. ë¡œê·¸ì¸ì„ í•˜ê³  ì¢‹ì•„ìš” ë²„íŠ¼ì´ ëˆŒë¦¬ì§€ ì•Šì€ ìƒíƒœì—ì„œ ì¢‹ì•„ìš” ë²„íŠ¼ì„ í´ë¦­í•˜ë©´, ì•„ì§ ë„¤íŠ¸ì›Œí¬ ë¦¬ìŠ¤í°ìŠ¤ê°€ ì˜¤ì§€ ì•Šì•˜ì§€ë§Œ ì¢‹ì•„ìš” ë²„íŠ¼ì´ ë¨¼ì € í™œì„±í™”ë©ë‹ˆë‹¤.

![](https://velog.velcdn.com/images/pmj9498/post/726e5185-5406-489a-a008-7672b668d48b/image.png)
ì¢‹ì•„ìš”ì— ëŒ€í•œ ì„œë²„ ë¦¬ìŠ¤í°ìŠ¤ë¥¼ ë°›ìœ¼ë©´ ë®¤í…Œì´ì…˜ì´ ëë‚˜ê³  ë‚˜ë©´ í•´ë‹¹ í¬ìŠ¤íŠ¸ì˜ ì¢‹ì•„ìš” ë°ì´í„°ê°€ refetchë©ë‹ˆë‹¤.
![](https://velog.velcdn.com/images/pmj9498/post/169bbad3-7ff5-405c-a41b-dd6ca93dd576/image.png)
refetchê¹Œì§€ ì™„ë£Œë˜ì–´ ìºì‹œ ë°ì´í„°ê°€ ì„œë²„ì™€ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
![](https://velog.velcdn.com/images/pmj9498/post/7411006e-256d-42c1-9b51-f1aee9e6a6cb/image.png)
ìµœì¢… ì½”ë“œì…ë‹ˆë‹¤.

```js
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import {
  getLikeCountByPostId,
  getLikeStatusByUsername,
  likePost,
  unlikePost,
} from "./api";

function Post({ post, currentUsername }) {
  const queryClient = useQueryClient();

  const { data: likeCount } = useQuery({
    queryKey: ["likeCount", post.id],
    queryFn: () => getLikeCountByPostId(post.id),
  });

  const { data: isPostLikedByCurrentUser } = useQuery({
    queryKey: ["likeStatus", post.id, currentUsername],
    queryFn: () => getLikeStatusByUsername(post.id, currentUsername),
    enabled: !!currentUsername,
  });

  const likesMutation = useMutation({
    mutationFn: async ({ postId, username, userAction }) => {
      if (userAction === "LIKE_POST") {
        await likePost(postId, username);
      } else {
        await unlikePost(postId, username);
      }
    },
    onMutate: async ({ postId, username, userAction }) => {
      await queryClient.cancelQueries({
        queryKey: ["likeStatus", postId, username],
      });
      await queryClient.cancelQueries({ queryKey: ["likeCount", postId] });

      const prevLikeStatus = queryClient.getQueryData([
        "likeStatus",
        postId,
        username,
      ]);
      const prevLikeCount = queryClient.getQueryData(["likeCount", postId]);

      queryClient.setQueryData(
        ["likeStatus", postId, username],
        () => userAction === "LIKE_POST"
      );
      queryClient.setQueryData(["likeCount", postId], (prev) =>
        userAction === "LIKE_POST" ? prev + 1 : prev - 1
      );

      return { prevLikeStatus, prevLikeCount };
    },
    onError: (err, { postId, username }, context) => {
      queryClient.setQueryData(
        ["likeStatus", postId, username],
        context.prevLikeStatus
      );
      queryClient.setQueryData(["likeCount", postId], context.prevLikeCount);
    },
    onSettled: (data, err, { postId, username }) => {
      queryClient.invalidateQueries({
        queryKey: ["likeStatus", postId, username],
      });
      queryClient.invalidateQueries({
        queryKey: ["likeCount", postId],
      });
    },
  });

  const handleLikeButtonClick = (userAction) => {
    console.log("@@@here", currentUsername);
    if (!currentUsername) return;
    likesMutation.mutate({
      postId: post.id,
      username: currentUsername,
      userAction,
    });
  };

  return (
    <li>
      <div>
        {post.user.name}: {post.content}
      </div>
      <button
        onClick={() =>
          handleLikeButtonClick(
            isPostLikedByCurrentUser ? "UNLIKE_POST" : "LIKE_POST"
          )
        }
      >
        {isPostLikedByCurrentUser ? "â™¥ï¸ " : "â™¡ "}
        {`ì¢‹ì•„ìš” ${likeCount ?? 0}ê°œ`}
      </button>
    </li>
  );
}

export default Post;
```

## ğŸ”¥ ë‹¤ì–‘í•œ ì¿¼ë¦¬ ì‚¬ìš©í•˜ê¸° ì •ë¦¬ ë° ìš”ì•½

ì´ë²ˆ ì±•í„°ì—ì„œ ìš°ë¦¬ëŠ” Dependant Queryë¥¼ êµ¬í˜„í•˜ëŠ” ë²•ê³¼ `useQuery()`ì˜ `placeholderData` ì˜µì…˜ìœ¼ë¡œ ìì—°ìŠ¤ëŸ¬ìš´ í˜ì´ì§€ë„¤ì´ì…˜ì„ êµ¬í˜„í•˜ëŠ” ë²•ì„ ë°°ì›Œ ë³´ì•˜ìŠµë‹ˆë‹¤. ë˜í•œ `useInfiniteQuery()`ë¥¼ í™œìš©í•´ ë” ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ êµ¬í˜„í•˜ê³ , Optimistic Updateì˜ ê°œë…ê³¼ êµ¬í˜„ ë°©ë²•ê¹Œì§€ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.

### Dependant Query

ì–´ë–¤ íŠ¹ì • ê°’ì„ ë¨¼ì € ë°›ì•„ì˜¤ê±°ë‚˜ ì–´ë–¤ ì¡°ê±´ì´ ë˜ì—ˆì„ ë•Œ ì¿¼ë¦¬ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ `enabled` ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.

```js
const { data: userInfoData } = useQuery({
  queryKey: queryKey,
  queryFn: queryFn,
  enabled: !!username,
});
```

### Paginated Query

ì¿¼ë¦¬ í‚¤ì— í˜ì´ì§€ ì •ë³´ë¥¼ í¬í•¨í•´ì„œ í˜ì´ì§€ë„¤ì´ì…˜ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `placeholderData` ì˜µì…˜ì„ í™œìš©í•˜ë©´, ìƒˆë¡œìš´ í˜ì´ì§€ë¥¼ ë³´ì—¬ì¤„ ë•Œ ì´ì „ì˜ ë°ì´í„°ë¥¼ ë³´ì—¬ ì£¼ë‹¤ê°€ ìƒˆë¡œìš´ ë°ì´í„°ê°€ ì˜¤ë©´ ìì—°ìŠ¤ëŸ½ê²Œ ì „í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```js
const { data: postsData } = useQuery({
  queryKey: ["posts", page],
  queryFn: () => getPosts(page, PAGE_LIMIT),
  placeholderData: keepPreviousData,
});
```

`prefetchQuery()` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ ë‹¤ìŒ í˜ì´ì§€ì˜ ë°ì´í„°ë¥¼ ë¯¸ë¦¬ fetchí•˜ë„ë¡ êµ¬í˜„í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

```js
useEffect(() => {
  if (!isPlaceholderData && postsData?.hasMore) {
    queryClient.prefetchQuery({
      queryKey: ["posts", page + 1],
      queryFn: () => getPosts(page + 1, PAGE_LIMIT),
    });
  }
}, [isPlaceholderData, postsData, queryClient, page]);
```

### Infinite Query

```js
const {
  data: postsData,
  isPending,
  isError,
  hasNextPage,
  fetchNextPage,
  isFetchingNextPage,
} = useInfiniteQuery({
  queryKey: ["posts"],
  queryFn: ({ pageParam }) => getPosts(pageParam, LIMIT),
  initialPageParam: 0,
  getNextPageParam: (lastPage, allPages, lastPageParam, allPageParams) =>
    lastPage.hasMore ? lastPageParam + 1 : undefined,
});
```

`useInfiniteQuery()` í›…ì—ì„œëŠ” page param ê°’ì„ í™œìš©í•˜ì—¬ í˜ì´ì§€ë¥¼ ë” ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.

`useQuery()`ì—ì„œëŠ” `data`ì— í•œ í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ë§Œ ë‹´ê³  ìˆì—ˆì§€ë§Œ, `useInfiniteQuery()`ì—ì„œëŠ” `data`ì— ëª¨ë“  í˜ì´ì§€ì˜ ë°ì´í„°ê°€ `pages`ë¼ëŠ” í”„ë¡œí¼í‹°ë¡œ ë°°ì—´ì— ë‹´ê²¨ ìˆìŠµë‹ˆë‹¤.

`getNextPageParam()` í•¨ìˆ˜ì—ì„œ ë‹¤ìŒ í˜ì´ì§€ê°€ ìˆëŠ” ê²½ìš° ë‹¤ìŒ page param ê°’ì„ ë¦¬í„´í•˜ëŠ”ë°ìš”, `fetchNextPage()` í•¨ìˆ˜ì—ì„œëŠ” ì´ë ‡ê²Œ ë¦¬í„´ëœ page param ê°’ì„ ì¿¼ë¦¬ í•¨ìˆ˜ë¡œ ì „ë‹¬í•´ ë‹¤ìŒ í˜ì´ì§€ì˜ ë°ì´í„°ë¥¼ ë°›ì•„ì˜µë‹ˆë‹¤.

ë§Œì•½ `getNextPageParams()` í•¨ìˆ˜ì—ì„œ `undefined`ë‚˜ `null` ê°’ì„ ë¦¬í„´í•˜ë©´ ë‹¤ìŒ í˜ì´ì§€ê°€ ì—†ëŠ” ê²ƒìœ¼ë¡œ ê°„ì£¼í•´ `fetchNextPage()` í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•´ë„ ë” ì´ìƒ ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ì§€ ì•Šê³ , `hasNextPage`ì˜ ê°’ë„ `false`ê°€ ë©ë‹ˆë‹¤.

### Optimistic updates

Optimistic updatesëŠ” ì„œë²„ê°€ ì œëŒ€ë¡œ ë™ì‘í•  ê²ƒì„ ë‚™ê´€ì ìœ¼ë¡œ ê¸°ëŒ€í•˜ë©°, ì„œë²„ë¡œë¶€í„°ì˜ ë¦¬ìŠ¤í°ìŠ¤ë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ìœ ì €ì—ê²Œ ë°”ë¡œ í”¼ë“œë°±ì„ ì£¼ëŠ” ë°©ì‹ì„ ë§í•©ë‹ˆë‹¤.

`useMutation()`ì˜ `onMutate`, `onError`, `onSettled` ì˜µì…˜ì„ í™œìš©í•´ Optimistic updatesë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```js
const likeMutation = useMutation({
  mutationFn: async ({ postId, username, userAction }) => {
    if (userAction === USER_ACTION.LIKE_POST) {
      await likePost(postId, username);
    } else {
      await unlikePost(postId, username);
    }
  },
  onMutate: async ({ postId, username, userAction }) => {
    await queryClient.cancelQueries({
      queryKey: [QUERY_KEYS.LIKE_STATUS, postId],
    });
    await queryClient.cancelQueries({
      queryKey: [QUERY_KEYS.NUM_OF_LIKES, postId],
    });

    const prevLikeStatus = queryClient.getQueryData([
      QUERY_KEYS.LIKE_STATUS,
      postId,
      username,
    ]);
    const prevLikeCount = queryClient.getQueryData([
      QUERY_KEYS.LIKE_COUNT,
      postId,
    ]);

    queryClient.setQueryData(
      [QUERY_KEYS.LIKE_STATUS, postId, username],
      () => userAction === USER_ACTION.LIKE_POST
    );
    queryClient.setQueryData([QUERY_KEYS.LIKE_COUNT, postId], (prev) => {
      userAction === USER_ACTION.LIKE_POST ? prev + 1 : prev - 1;
    });

    return { prevLikeStatus, prevLikeCount };
  },
  onError: (err, { postId, username }, context) => {
    queryClient.setQueryData(
      [QUERY_KEYS.LIKE_STATUS, postId, username],
      context.prevLikeStatus
    );
    queryClient.setQueryData(
      [QUERY_KEYS.LIKE_COUNT, postId],
      context.prevLikeCount
    );
  },
  onSettled: (data, err, { postId, username }) => {
    queryClient.invalidateQueries({
      queryKey: [QUERY_KEYS.LIKE_STATUS, postId, username],
    });
    queryClient.invalidateQueries({
      queryKey: [QUERY_KEYS.LIKE_COUNT, postId],
    });
  },
});
```

#### `onMutate`

1. ìš°ë¦¬ê°€ ì˜µí‹°ë¯¸ìŠ¤í‹± ì—…ë°ì´íŠ¸ë¥¼ í†µí•´ ë³€ê²½í•˜ë ¤ê³  í•˜ëŠ” ë°ì´í„°ê°€ refetchë¡œ ì¸í•´ ë®ì–´ì”Œì›Œì§€ëŠ” ê²ƒì„ ë§‰ê¸° ìœ„í•´ cancelQueries()ë¥¼ ì‹¤í–‰í•˜ì—¬, ì¢‹ì•„ìš” ê´€ë ¨ ë°ì´í„°ë¥¼ ë°›ì•„ ì˜¤ì§€ ì•Šë„ë¡ ì¿¼ë¦¬ë¥¼ ì·¨ì†Œí•´ ì¤ë‹ˆë‹¤.
2. ì—ëŸ¬ê°€ ë°œìƒí–ˆì„ ë•ŒëŠ” ì´ì „ì˜ ë°ì´í„°ë¡œ ë¡¤ë°±í•´ ì¤˜ì•¼ í•˜ëŠ”ë°ìš”. ë¡¤ë°±ìš© ë°ì´í„°ë¥¼ ë”°ë¡œ ì €ì¥í•´ ì¤ë‹ˆë‹¤.
3. ìš°ë¦¬ê°€ ì›í•˜ëŠ” ê°’ìœ¼ë¡œ ì¿¼ë¦¬ ë°ì´í„°ë¥¼ ë¯¸ë¦¬ ë³€ê²½í•©ë‹ˆë‹¤.
4. ë§ˆì§€ë§‰ìœ¼ë¡œ ë¡¤ë°±ìš© ë°ì´í„°ë¥¼ ë¦¬í„´í•´ ì£¼ë©´ ë©ë‹ˆë‹¤.

#### `onError`

ë¡¤ë°±ìš© ë°ì´í„°ë¥¼ ì„¸ ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì¸ `context`ë¡œ ë°›ì•„ ì˜µë‹ˆë‹¤. `context` ê°’ìœ¼ë¡œ ì¿¼ë¦¬ ë°ì´í„°ë¥¼ ë³€ê²½í•´ ì¤ë‹ˆë‹¤.

#### `onSettled`

ì—ëŸ¬ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ ë°±ì—”ë“œ ì„œë²„ì™€ ë°ì´í„°ë¥¼ ë™ê¸°í™”í•´ì£¼ê¸° ìœ„í•´ ì¢‹ì•„ìš” ê´€ë ¨ ë°ì´í„° ì¿¼ë¦¬ë¥¼ invalidateí•´ ì¤ë‹ˆë‹¤.

## ğŸš© Next.jsì—ì„œ React Query ì‚¬ìš©í•˜ê¸°

ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ëŠ” Next.jsì™€ ê°™ì€ ì„œë²„ ì‚¬ì´ë“œ ë Œë”ë§ì„ ì œê³µí•˜ëŠ” í”„ë ˆì„ì›Œí¬ì™€ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. [ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ ê³µì‹ ë¬¸ì„œ](https://tanstack.com/query/latest/docs/framework/react/guides/ssr)ë¥¼ í†µí•´ ìì„¸í•œ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆëŠ”ë°ìš”. ì„œë²„ì—ì„œ ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ë©´ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•´ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì„œë²„ì—ì„œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•´ ë°ì´í„°ë¥¼ prefetchí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë²ˆ ë ˆìŠ¨ì—ì„œëŠ” Next.jsì—ì„œ ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ê°„ë‹¨íˆ ì•Œì•„ë³´ë„ë¡ í• ê²Œìš”.

### ì´ˆê¸° ì„¤ì •

```js
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";

export default function App({ Component, pageProps }) {
  const [queryClient] = React.useState(
    () =>
      new QueryClient({
        defaultOptions: {
          queries: {
            // ë³´í†µ SSRì—ì„œëŠ” staleTimeì„ 0 ì´ìƒìœ¼ë¡œ í•´ì¤Œìœ¼ë¡œì¨
            // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œ ë°”ë¡œ ë‹¤ì‹œ ë°ì´í„°ë¥¼ refetch í•˜ëŠ” ê²ƒì„ í”¼í•œë‹¤.
            staleTime: 60 * 1000,
          },
        },
      })
  );

  return (
    <QueryClientProvider client={queryClient}>
      <Component {...pageProps} />
    </QueryClientProvider>
  );
}
```

ë¨¼ì € `App` ì»´í¬ë„ŒíŠ¸ì—ì„œ ì´ˆê¸° ì„¤ì •ì„ í•´ ì¤ë‹ˆë‹¤. Next.jsì—ì„œëŠ” ê¸°ì¡´ì˜ ë¦¬ì•¡íŠ¸ í”„ë¡œì íŠ¸ì™€ëŠ” ë‹¤ë¥´ê²Œ `App` ì»´í¬ë„ŒíŠ¸ ì•ˆì— ìƒˆë¡œìš´ `QueryClient`ë¥¼ `useState()`ë¥¼ ì‚¬ìš©í•´ stateë¡œ ì„ ì–¸í•´ ì¤˜ì•¼ í•©ë‹ˆë‹¤.

`App` ì»´í¬ë„ŒíŠ¸ ë°”ê¹¥ì— ì„ ì–¸í•˜ê²Œ ë˜ë©´ ì„œë²„ ë Œë”ë§ì‹œ ì¿¼ë¦¬ ìºì‹œê°€ ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ê³¼ ë¦¬í€˜ìŠ¤íŠ¸ ê°„ì— ê³µìœ ê°€ ë  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ë°˜ë“œì‹œ `App` ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì— ì„ ì–¸ì„ í•´ì£¼ê³ ìš”. Next.jsì—ì„œëŠ” í˜ì´ì§€ë¥¼ ì´ë™í•˜ë©´ `App` ì»´í¬ë„ŒíŠ¸ë¶€í„° ìƒˆë¡­ê²Œ ë Œë”ë§ë˜ê¸° ë•Œë¬¸ì— ì¿¼ë¦¬ í´ë¼ì´ì–¸íŠ¸ê°€ ë§¤ë²ˆ ìƒˆë¡­ê²Œ ìƒì„±ë˜ëŠ” ê²ƒì„ ë§‰ê¸° ìœ„í•˜ì—¬ stateë¡œ ì €ì¥í•´ ì¤ë‹ˆë‹¤.

### Prefetch êµ¬í˜„í•˜ê¸°

ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ì—ì„œëŠ” ë‘ ê°€ì§€ ë°©ë²•ìœ¼ë¡œ prefetchingì„ ì§€ì›í•©ë‹ˆë‹¤.

#### `initialData`ë¥¼ ì‚¬ìš©í•œ prefetching

```js
export async function getServerSideProps() {
  const posts = await getPosts();
  return { props: { posts } };
}

function Posts(props) {
  const { data } = useQuery({
    queryKey: ["posts"],
    queryFn: getPosts,
    initialData: props.posts,
  });

  // ...
}
```

ì´ ë°©ë²•ì€ Next.jsì—ì„œ ì •ì  ìƒì„±, ì„œë²„ ì‚¬ì´ë“œ ë Œë”ë§ì„ í•˜ë©´ì„œ prefetchí•œ ë°ì´í„°ë¥¼ `useQuery()`ì˜ `initialData`ë¡œ ì„¤ì •í•´ ì£¼ëŠ” ë°©ë²•ì…ë‹ˆë‹¤. ì‚¬ìš© ë°©ë²•ì´ ë§¤ìš° ê°„ë‹¨í•œë°ìš”, prefetching ë‹¨ê³„ì—ì„œëŠ” ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ë¥¼ ì „í˜€ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ëœë‹¤ëŠ” ì¥ì ì´ ìˆìŠµë‹ˆë‹¤.

ë‹¤ë§Œ ëª‡ ê°€ì§€ ë‹¨ì ë“¤ë„ ìˆëŠ”ë°ìš”.

`getStaticProps()`, `getServerSideProps()`ëŠ” `pages` í´ë” ì•ˆì—ì„œë§Œ ë™ì‘í•˜ê¸° ë•Œë¬¸ì— `useQuery()`ë¥¼ ì‚¬ìš©í•˜ë ¤ëŠ” ì»´í¬ë„ŒíŠ¸ê¹Œì§€ prefetchí•œ ë°ì´í„°ë¥¼ props drillingìœ¼ë¡œ ë‚´ë ¤ ì¤˜ì•¼ë§Œ í•©ë‹ˆë‹¤.

ë˜í•œ ê°™ì€ ì¿¼ë¦¬ì˜ `useQuery()`ë¥¼ ì—¬ëŸ¬ êµ°ë°ì„œ ì‚¬ìš©í•œë‹¤ë©´, ëª¨ë“  `useQuery()`ì— ë˜‘ê°™ì€ `initialData`ë¥¼ ì„¤ì •í•´ ì¤˜ì•¼ í•˜ëŠ” ë¬¸ì œë„ ìˆê³ ìš”.

ì¿¼ë¦¬ê°€ ì„œë²„ë¡œë¶€í„° ì–¸ì œ fetch ë˜ì—ˆëŠ”ì§€ ì •í™•íˆ ì•Œ ìˆ˜ ì—†ê¸° ë•Œë¬¸ì—, `dataUpdatedAt`ì˜ ì‹œê°„ì´ë‚˜ ì¿¼ë¦¬ refetchingì´ í•„ìš”í•œì§€ ì—¬ë¶€ëŠ” í˜ì´ì§€ê°€ ë¡œë“œëœ ì‹œì ìœ¼ë¡œë¶€í„° ê³„ì‚°ëœë‹¤ëŠ” í•œê³„ì ë„ ìˆìŠµë‹ˆë‹¤.

ì¶”ê°€ì ìœ¼ë¡œ ë§Œì•½ ì–´ë–¤ ì¿¼ë¦¬ í‚¤ë¡œ ìºì‹±ëœ ë°ì´í„°ê°€ ì´ë¯¸ ìˆë‹¤ë©´ `initialData`ëŠ” í•´ë‹¹ ë°ì´í„°ë¥¼ ì ˆëŒ€ ë®ì–´ì“°ì§€ ì•ŠëŠ”ë°ìš”. ë”°ë¼ì„œ ì´ë¯¸ ìºì‹±ëœ ë°ì´í„°ê°€ ë” ì˜¤ë˜ ëœ ê²ƒì´ë”ë¼ë„, `getServerSideProps()` í•¨ìˆ˜ë¡œ ë°›ì•„ ì˜¨ ë°ì´í„°ëŠ” `initialData`ë¡œ ì„¤ì •ì´ ë˜ê¸° ë•Œë¬¸ì— ìƒˆë¡œìš´ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸í•  ìˆ˜ ì—†ë‹¤ëŠ” ë‹¨ì ì´ ìˆìŠµë‹ˆë‹¤.

#### Hydration API ì‚¬ìš©í•˜ê¸°

```js
import { dehydrate, HydrationBoundary, QueryClient, useQuery } from '@tanstack/react-query'

export async function getStaticProps() {
  const queryClient = new QueryClient()

  await queryClient.prefetchQuery({
    queryKey: ['posts'],
    queryFn: getPosts,
  })

  return {
    props: {
      dehydratedState: dehydrate(queryClient),
    },
  }
}

function Posts() {
  const { data } = useQuery({ queryKey: ['posts'], queryFn: getPosts })

  // ì´ ì¿¼ë¦¬ëŠ” ì„œë²„ì—ì„œ prefetchí•˜ì§€ ì•ŠëŠ” ë°ì´í„°.
    // prefetchí•˜ëŠ” ë°ì´í„°ì™€ ì•„ë‹Œ ë°ì´í„°ë¥¼ ììœ ë¡­ê²Œ ì„ì–´ì„œ í™œìš©í•  ìˆ˜ ìˆë‹¤.
  const { data: commentsData } = useQuery({
    queryKey: ['posts-comments'],
    queryFn: getComments,
  })

  // ...
}

export default PostsRoute({ dehydratedState }) {
  return (
    <HydrationBoundary state={dehydratedState}>
      <Posts />
    </HydrationBoundary>
  )
}
```

Hydrationì— ëŒ€í•œ ì„¤ëª…ì€ [Nextjsì˜ í”„ë¦¬ë Œë”ë§ì´ë€?](https://www.codeit.kr/topics/building-a-website-with-nextjs/lessons/5977) ê°•ì˜ì—ì„œ ê°„ë‹¨íˆ ì‚´í´ë³´ì•˜ì—ˆëŠ”ë°ìš”. ê°„ë‹¨íˆ ë§í•´ì„œ ì´ë¯¸ ë Œë”ë§ëœ HTMLê³¼ ë¦¬ì•¡íŠ¸ë¥¼ ì—°ê²°í•˜ëŠ” ì‘ì—…ì„ ë§í•©ë‹ˆë‹¤. ì •ì ì¸ HTMLì„ ë¦¬ì•¡íŠ¸ ì½”ë“œì™€ ì—°ê²°í•´ì„œ ë™ì ì¸ ìƒíƒœë¡œ ë°”ê¿” ì£¼ëŠ” ê±¸ ìˆ˜ë¶„ì„ ë³´ì¶©í•œë‹¤ëŠ” ì˜ë¯¸ë¡œ hydrateì´ë¼ê³  í‘œí˜„í•©ë‹ˆë‹¤.

dehydrateì€ hydrateì˜ ë°˜ëŒ€ë˜ëŠ” ë§ì¸ë°ìš”. ë™ì ì¸ ê²ƒì„ ë‹¤ì‹œ ì •ì ì¸ ìƒíƒœë¡œ ë§Œë“œëŠ” ì‘ì—…ì„ ë§í•©ë‹ˆë‹¤. ìœ„ ì½”ë“œì—ì„œëŠ” prefetchí•œ ê²°ê´ê°’ì´ ë‹´ê¸´ `queryClient`ë¥¼ dehydrateí•´ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œ ë³´ë‚´ ì£¼ì—ˆìŠµë‹ˆë‹¤.

ì´ë ‡ê²Œ í•˜ë©´ ì´ˆê¸° ì„¤ì • ì½”ë“œê°€ ëŠ˜ì–´ë‚˜ì§€ë§Œ `initialData`ë¥¼ ì´ìš©í•˜ë©´ì„œ ë°œìƒí•˜ëŠ” ì—¬ëŸ¬ ë‹¨ì ì„ ëª¨ë‘ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
